{"version":3,"file":"use-context-selector-v2.modern.mjs","sources":["../src/use-context-selector-v2.js"],"sourcesContent":["import React, {\n  useState,\n  useContext,\n  useRef,\n  useEffect,\n  createContext as createContextOriginal,\n} from \"react\";\n\n/**\n * @description use this instead of React.useContext\n * @param {*} Context a context created with createContext from this package\n * @param {*} selector | [\"key\",\"key\",\"key\"] || {key:1,key:,key:1} || (state)=>({ key1:state.key}) || (state)=>state.key\n * @returns\n */\nexport function useContextSelector(Context, selector) {\n  if (typeof selector === \"function\") return useSelector(Context, selector);\n  if (Array.isArray(selector))\n    return useSelector(Context, (_) =>\n      selector.reduce((a, c) => ({ ...a, [c]: _[c] }), {})\n    );\n  if (typeof selector === \"object\")\n    return useSelector(Context, (_) =>\n      Object.keys(selector)\n        .filter((_) => selector[_])\n        .reduce((a, c) => ({ ...a, [c]: _[c] }), {})\n    );\n}\n\n/**\n * @description use this instead of React.createContext\n * @returns a context with a Provider that has a value property that is a ref\n */\nexport function createContext() {\n  const context = createContextOriginal();\n  delete context.Consumer;\n  context.Provider = createProvider(context.Provider);\n  return context;\n}\n\nfunction createProvider(ProviderOriginal) {\n  return ({ value, children }) => {\n    const valueRef = useRef(value);\n    const listenersRef = useRef(new Set());\n    const contextValue = useRef({\n      value: valueRef,\n      registerListener: (listener) => {\n        listenersRef.current.add(listener);\n        return () => listenersRef.current.delete(listener);\n      },\n      listeners: new Set(),\n    });\n    useEffect(() => {\n      listenersRef.current.forEach((listener) => {\n        listener(value, valueRef.current);\n      });\n      valueRef.current = value;\n    }, [value]);\n    return (\n      <ProviderOriginal value={contextValue.current}>\n        {children}\n      </ProviderOriginal>\n    );\n  };\n}\n\nfunction useSelector(context, selector) {\n  const { value, registerListener } = useContext(context);\n  const [selectedValue, setSelectedValue] = useState(() =>\n    selector(value.current)\n  );\n  const selectorRef = useRef(selector);\n\n  useEffect(() => {\n    selectorRef.current = selector;\n  }, [selector, selectorRef]);\n\n  useEffect(() => {\n    const updateValueIfNeeded = (newValue, prevVal) => {\n      const newS = selectorRef.current(newValue);\n      const prevS = selectorRef.current(prevVal);\n      if (JSON.stringify(newS) !== JSON.stringify(prevS))\n        setSelectedValue(() => newS);\n    };\n    const unregisterListener = registerListener((_, prevVal) =>\n      updateValueIfNeeded(_, prevVal)\n    );\n    return unregisterListener;\n  }, [registerListener, value]);\n\n  return selectedValue;\n}\n"],"names":["useContextSelector","Context","selector","useSelector","Array","isArray","_","reduce","a","c","_extends","Object","keys","filter","createContext","context","createContextOriginal","ProviderOriginal","Consumer","Provider","value","children","valueRef","useRef","listenersRef","Set","contextValue","registerListener","listener","current","add","delete","listeners","useEffect","forEach","h","useContext","selectedValue","setSelectedValue","useState","selectorRef","prevVal","updateValueIfNeeded","newValue","newS","prevS","JSON","stringify"],"mappings":"mUAcgB,SAAAA,EAAmBC,EAASC,GAC1C,MAAwB,mBAAbA,EAAgCC,EAAYF,EAASC,GAC5DE,MAAMC,QAAQH,GACTC,EAAYF,EAAUK,GAC3BJ,EAASK,OAAO,CAACC,EAAGC,IAACC,EAAA,CAAA,EAAWF,EAAG,CAAAC,CAACA,GAAIH,EAAEG,KAAO,CAAA,IAE7B,iBAAbP,EACFC,EAAYF,EAAUK,GAC3BK,OAAOC,KAAKV,GACTW,OAAQP,GAAMJ,EAASI,IACvBC,OAAO,CAACC,EAAGC,IAACC,EAAA,CAAA,EAAWF,EAAC,CAAEC,CAACA,GAAIH,EAAEG,KAAO,CAAE,SAJjD,CAMF,UAMgBK,IACd,MAAMC,eAAUC,IAMlB,IAAwBC,EAHtB,cAFOF,EAAQG,SACfH,EAAQI,UAIcF,EAJYF,EAAQI,SAKnC,EAAGC,QAAOC,eACf,MAAMC,EAAWC,EAAOH,GAClBI,EAAeD,EAAO,IAAIE,KAC1BC,EAAeH,EAAO,CAC1BH,MAAOE,EACPK,iBAAmBC,IACjBJ,EAAaK,QAAQC,IAAIF,GAClB,IAAMJ,EAAaK,QAAQE,OAAOH,IAE3CI,UAAW,IAAIP,MAQjB,OANAQ,EAAU,KACRT,EAAaK,QAAQK,QAASN,IAC5BA,EAASR,EAAOE,EAASO,WAE3BP,EAASO,QAAUT,CACrB,EAAG,CAACA,IAEFe,EAAClB,EAAiBG,CAAAA,MAAOM,EAAaG,SACnCR,EACe,GAxBfN,CACT,CA4BA,SAASZ,EAAYY,EAASb,GAC5B,MAAMkB,MAAEA,EAAKO,iBAAEA,GAAqBS,EAAWrB,IACxCsB,EAAeC,GAAoBC,EAAS,IACjDrC,EAASkB,EAAMS,UAEXW,EAAcjB,EAAOrB,GAmB3B,OAjBA+B,EAAU,KACRO,EAAYX,QAAU3B,CAAAA,EACrB,CAACA,EAAUsC,IAEdP,EAAU,IAOmBN,EAAiB,CAACrB,EAAGmC,IANpBC,EAACC,EAAUF,KACrC,MAAMG,EAAOJ,EAAYX,QAAQc,GAC3BE,EAAQL,EAAYX,QAAQY,GAC9BK,KAAKC,UAAUH,KAAUE,KAAKC,UAAUF,IAC1CP,EAAiB,IAAMM,IAGzBF,CAAoBpC,EAAGmC,IAGxB,CAACd,EAAkBP,IAEfiB,CACT"}