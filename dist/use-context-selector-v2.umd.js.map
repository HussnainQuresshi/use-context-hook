{"version":3,"file":"use-context-selector-v2.umd.js","sources":["../src/use-context-selector-v2.js"],"sourcesContent":["import React, {\n  useState,\n  useContext,\n  useRef,\n  useEffect,\n  createContext as createContextOriginal,\n} from \"react\";\n\n/**\n * @description use this instead of React.useContext\n * @param {*} Context a context created with createContext from this package\n * @param {*} selector | [\"key\",\"key\",\"key\"] || {key:1,key:,key:1} || (state)=>({ key1:state.key}) || (state)=>state.key\n * @returns\n */\nexport function useContextSelector(Context, selector) {\n  if (typeof selector === \"function\") return useSelector(Context, selector);\n  if (Array.isArray(selector))\n    return useSelector(Context, (_) =>\n      selector.reduce((a, c) => ({ ...a, [c]: _[c] }), {})\n    );\n  if (typeof selector === \"object\")\n    return useSelector(Context, (_) =>\n      Object.keys(selector)\n        .filter((_) => selector[_])\n        .reduce((a, c) => ({ ...a, [c]: _[c] }), {})\n    );\n}\n\n/**\n * @description use this instead of React.createContext\n * @returns a context with a Provider that has a value property that is a ref\n */\nexport function createContext() {\n  const context = createContextOriginal();\n  delete context.Consumer;\n  context.Provider = createProvider(context.Provider);\n  return context;\n}\n\nfunction createProvider(ProviderOriginal) {\n  return ({ value, children }) => {\n    const valueRef = useRef(value);\n    const listenersRef = useRef(new Set());\n    const contextValue = useRef({\n      value: valueRef,\n      registerListener: (listener) => {\n        listenersRef.current.add(listener);\n        return () => listenersRef.current.delete(listener);\n      },\n      listeners: new Set(),\n    });\n    useEffect(() => {\n      listenersRef.current.forEach((listener) => {\n        listener(value, valueRef.current);\n      });\n      valueRef.current = value;\n    }, [value]);\n    return (\n      <ProviderOriginal value={contextValue.current}>\n        {children}\n      </ProviderOriginal>\n    );\n  };\n}\n\nfunction useSelector(context, selector) {\n  const { value, registerListener } = useContext(context);\n  const [selectedValue, setSelectedValue] = useState(() =>\n    selector(value.current)\n  );\n  const selectorRef = useRef(selector);\n\n  useEffect(() => {\n    selectorRef.current = selector;\n  }, [selector, selectorRef]);\n\n  useEffect(() => {\n    const updateValueIfNeeded = (newValue, prevVal) => {\n      const newS = selectorRef.current(newValue);\n      const prevS = selectorRef.current(prevVal);\n      if (JSON.stringify(newS) !== JSON.stringify(prevS))\n        setSelectedValue(() => newS);\n    };\n    const unregisterListener = registerListener((_, prevVal) =>\n      updateValueIfNeeded(_, prevVal)\n    );\n    return unregisterListener;\n  }, [registerListener, value]);\n\n  return selectedValue;\n}\n"],"names":["useSelector","context","selector","_useContext","useContext","value","registerListener","_useState","useState","current","selectedValue","setSelectedValue","selectorRef","useRef","useEffect","_","prevVal","newValue","newS","prevS","JSON","stringify","updateValueIfNeeded","ProviderOriginal","createContextOriginal","createContext","Consumer","Provider","_ref","children","valueRef","listenersRef","Set","contextValue","listener","add","listeners","forEach","h","Context","Array","isArray","reduce","a","c","_extends2","_extends","Object","keys","filter","_extends3"],"mappings":"qfAiEA,SAASA,EAAYC,EAASC,GAC5B,IAAAC,EAAoCC,EAAAA,WAAWH,GAAvCI,EAAKF,EAALE,MAAOC,EAAgBH,EAAhBG,iBACfC,EAA0CC,EAAAA,SAAS,WAAA,OACjDN,EAASG,EAAMI,QAAQ,GADlBC,EAAaH,EAAEI,GAAAA,EAAgBJ,EAGtC,GAAMK,EAAcC,EAAAA,OAAOX,GAmB3B,OAjBAY,EAASA,UAAC,WACRF,EAAYH,QAAUP,CACxB,EAAG,CAACA,EAAUU,IAEdE,EAASA,UAAC,WAUR,OAH2BR,EAAiB,SAACS,EAAGC,GAAO,OAN3B,SAACC,EAAUD,GACrC,IAAME,EAAON,EAAYH,QAAQQ,GAC3BE,EAAQP,EAAYH,QAAQO,GAC9BI,KAAKC,UAAUH,KAAUE,KAAKC,UAAUF,IAC1CR,EAAiB,WAAM,OAAAO,CAAI,EAC/B,CAEEI,CAAoBP,EAAGC,EAAQ,EAGnC,EAAG,CAACV,EAAkBD,IAEfK,CACT,iBA1DgB,WACd,IAMsBa,EANhBtB,eAAUuB,EAAqBC,gBAGrC,cAFOxB,EAAQyB,SACfzB,EAAQ0B,UAIcJ,EAJYtB,EAAQ0B,SAKnCC,SAAAA,GAAyB,IAAtBvB,EAAKuB,EAALvB,MAAOwB,EAAQD,EAARC,SACTC,EAAWjB,EAAAA,OAAOR,GAClB0B,EAAelB,EAAAA,OAAO,IAAImB,KAC1BC,EAAepB,EAAMA,OAAC,CAC1BR,MAAOyB,EACPxB,iBAAkB,SAAC4B,GAEjB,OADAH,EAAatB,QAAQ0B,IAAID,GAClB,WAAA,OAAMH,EAAatB,QAAc,OAACyB,EAAS,CACpD,EACAE,UAAW,IAAIJ,MAQjB,OANAlB,EAASA,UAAC,WACRiB,EAAatB,QAAQ4B,QAAQ,SAACH,GAC5BA,EAAS7B,EAAOyB,EAASrB,QAC3B,GACAqB,EAASrB,QAAUJ,CACrB,EAAG,CAACA,IAEFiC,EAACf,EAAgB,CAAClB,MAAO4B,EAAaxB,SACnCoB,EAGP,GA1BO5B,CACT,uBAvBO,SAA4BsC,EAASrC,GAC1C,MAAwB,mBAAbA,EAAgCF,EAAYuC,EAASrC,GAC5DsC,MAAMC,QAAQvC,GACTF,EAAYuC,EAAS,SAACxB,GAAC,OAC5Bb,EAASwC,OAAO,SAACC,EAAGC,GAACC,IAAAA,EAAAC,OAAAA,EAAWH,CAAAA,EAAAA,IAACE,EAAAA,CAAAA,GAAGD,GAAI7B,EAAE6B,GAAEC,GAAA,EAAK,CAAA,EAAG,GAEhC,iBAAb3C,EACFF,EAAYuC,EAAS,SAACxB,GAAC,OAC5BgC,OAAOC,KAAK9C,GACT+C,OAAO,SAAClC,GAAM,OAAAb,EAASa,EAAE,GACzB2B,OAAO,SAACC,EAAGC,GAAC,IAAAM,EAAA,OAAAJ,EAAA,CAAA,EAAWH,IAACO,EAAA,CAAA,GAAGN,GAAI7B,EAAE6B,GAAEM,GAAG,EAAE,CAAE,EAAC,QAJlD,CAMF"}