{"version":3,"file":"use-context-selector-v2.module.mjs","sources":["../src/use-context-selector-v2.js"],"sourcesContent":["import React, {\n  useState,\n  useContext,\n  useRef,\n  useEffect,\n  createContext as createContextOriginal,\n} from \"react\";\n\n/**\n * @description use this instead of React.useContext\n * @param {*} Context a context created with createContext from this package\n * @param {*} selector | [\"key\",\"key\",\"key\"] || {key:1,key:,key:1} || (state)=>({ key1:state.key}) || (state)=>state.key\n * @returns\n */\nexport function useContextSelector(Context, selector) {\n  if (typeof selector === \"function\") return useSelector(Context, selector);\n  if (Array.isArray(selector))\n    return useSelector(Context, (_) =>\n      selector.reduce((a, c) => ({ ...a, [c]: _[c] }), {})\n    );\n  if (typeof selector === \"object\")\n    return useSelector(Context, (_) =>\n      Object.keys(selector)\n        .filter((_) => selector[_])\n        .reduce((a, c) => ({ ...a, [c]: _[c] }), {})\n    );\n}\n\n/**\n * @description use this instead of React.createContext\n * @returns a context with a Provider that has a value property that is a ref\n */\nexport function createContext() {\n  const context = createContextOriginal();\n  delete context.Consumer;\n  context.Provider = createProvider(context.Provider);\n  return context;\n}\n\nfunction createProvider(ProviderOriginal) {\n  return ({ value, children }) => {\n    const valueRef = useRef(value);\n    const listenersRef = useRef(new Set());\n    const contextValue = useRef({\n      value: valueRef,\n      registerListener: (listener) => {\n        listenersRef.current.add(listener);\n        return () => listenersRef.current.delete(listener);\n      },\n      listeners: new Set(),\n    });\n    useEffect(() => {\n      listenersRef.current.forEach((listener) => {\n        listener(value, valueRef.current);\n      });\n      valueRef.current = value;\n    }, [value]);\n    return (\n      <ProviderOriginal value={contextValue.current}>\n        {children}\n      </ProviderOriginal>\n    );\n  };\n}\n\nfunction useSelector(context, selector) {\n  const { value, registerListener } = useContext(context);\n  const [selectedValue, setSelectedValue] = useState(() =>\n    selector(value.current)\n  );\n  const selectorRef = useRef(selector);\n\n  useEffect(() => {\n    selectorRef.current = selector;\n  }, [selector, selectorRef]);\n\n  useEffect(() => {\n    const updateValueIfNeeded = (newValue, prevVal) => {\n      const newS = selectorRef.current(newValue);\n      const prevS = selectorRef.current(prevVal);\n      if (JSON.stringify(newS) !== JSON.stringify(prevS))\n        setSelectedValue(() => newS);\n    };\n    const unregisterListener = registerListener((_, prevVal) =>\n      updateValueIfNeeded(_, prevVal)\n    );\n    return unregisterListener;\n  }, [registerListener, value]);\n\n  return selectedValue;\n}\n"],"names":["useContextSelector","Context","selector","useSelector","Array","isArray","_","reduce","a","c","_extends2","_extends","Object","keys","filter","_extends3","createContext","ProviderOriginal","context","createContextOriginal","Consumer","Provider","_ref","value","children","valueRef","useRef","listenersRef","Set","contextValue","registerListener","listener","current","add","listeners","useEffect","forEach","h","_useContext","useContext","_useState","useState","selectedValue","setSelectedValue","selectorRef","prevVal","newValue","newS","prevS","JSON","stringify","updateValueIfNeeded"],"mappings":"mUAcO,SAASA,EAAmBC,EAASC,GAC1C,MAAwB,mBAAbA,EAAgCC,EAAYF,EAASC,GAC5DE,MAAMC,QAAQH,GACTC,EAAYF,EAAS,SAACK,GAAC,OAC5BJ,EAASK,OAAO,SAACC,EAAGC,GAACC,IAAAA,EAAAC,OAAAA,EAAWH,CAAAA,EAAAA,IAACE,EAAAA,CAAAA,GAAGD,GAAIH,EAAEG,GAAEC,GAAA,EAAK,CAAA,EAAG,GAEhC,iBAAbR,EACFC,EAAYF,EAAS,SAACK,GAAC,OAC5BM,OAAOC,KAAKX,GACTY,OAAO,SAACR,GAAM,OAAAJ,EAASI,EAAE,GACzBC,OAAO,SAACC,EAAGC,GAAC,IAAAM,EAAA,OAAAJ,EAAA,CAAA,EAAWH,IAACO,EAAA,CAAA,GAAGN,GAAIH,EAAEG,GAAEM,GAAG,EAAE,CAAE,EAAC,QAJlD,CAMF,CAMgB,SAAAC,IACd,IAMsBC,EANhBC,eAAUC,IAGhB,cAFOD,EAAQE,SACfF,EAAQG,UAIcJ,EAJYC,EAAQG,SAKnCC,SAAAA,GAAyB,IAAtBC,EAAKD,EAALC,MAAOC,EAAQF,EAARE,SACTC,EAAWC,EAAOH,GAClBI,EAAeD,EAAO,IAAIE,KAC1BC,EAAeH,EAAO,CAC1BH,MAAOE,EACPK,iBAAkB,SAACC,GAEjB,OADAJ,EAAaK,QAAQC,IAAIF,GAClB,WAAA,OAAMJ,EAAaK,QAAc,OAACD,EAAS,CACpD,EACAG,UAAW,IAAIN,MAQjB,OANAO,EAAU,WACRR,EAAaK,QAAQI,QAAQ,SAACL,GAC5BA,EAASR,EAAOE,EAASO,QAC3B,GACAP,EAASO,QAAUT,CACrB,EAAG,CAACA,IAEFc,EAACpB,EAAgB,CAACM,MAAOM,EAAaG,SACnCR,EAGP,GA1BON,CACT,CA4BA,SAASf,EAAYe,EAAShB,GAC5B,IAAAoC,EAAoCC,EAAWrB,GAAvCK,EAAKe,EAALf,MAAOO,EAAgBQ,EAAhBR,iBACfU,EAA0CC,EAAS,WAAA,OACjDvC,EAASqB,EAAMS,QAAQ,GADlBU,EAAaF,EAAEG,GAAAA,EAAgBH,EAGtC,GAAMI,EAAclB,EAAOxB,GAmB3B,OAjBAiC,EAAU,WACRS,EAAYZ,QAAU9B,CACxB,EAAG,CAACA,EAAU0C,IAEdT,EAAU,WAUR,OAH2BL,EAAiB,SAACxB,EAAGuC,GAAO,OAN3B,SAACC,EAAUD,GACrC,IAAME,EAAOH,EAAYZ,QAAQc,GAC3BE,EAAQJ,EAAYZ,QAAQa,GAC9BI,KAAKC,UAAUH,KAAUE,KAAKC,UAAUF,IAC1CL,EAAiB,WAAM,OAAAI,CAAI,EAC/B,CAEEI,CAAoB7C,EAAGuC,EAAQ,EAGnC,EAAG,CAACf,EAAkBP,IAEfmB,CACT"}